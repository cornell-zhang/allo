<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>MLIR Translation Guide &#8212; Allo Documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/basic_mod.css?v=9b2032db" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <script src="../_static/documentation_options.js?v=db78e746"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=30646c52"></script>
    <script src="../_static/js/theme.js"></script>
    <script src="../_static/js/petite-vue.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Schedule Primitives" href="../api/index.html" />
    <link rel="prev" title="IR Builder Walkthrough" href="developer_01_ir_builder.html" /> 
  </head><body data-dark_mode_code_blocks="true">

<div id="top_nav">
    

    <nav>
        
            
        

        <p id="toggle_sidebar">
            <a href="#" title="Toggle sidebar">|||</a>
        </p>
        <h1><a href="../index.html" title="Go to homepage">Allo Documentation</a></h1>
            <a id="source_link" href="https://github.com/cornell-zhang/allo">
    
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512">
            <path fill="white" d="M 244.8,8 C 106.1,8 0,113.3 0,252 c 0,110.9 69.8,205.8 169.5,239.2 12.8,2.3 17.3,-5.6 17.3,-12.1 0,-6.2 -0.3,-40.4 -0.3,-61.4 0,0 -70,15 -84.7,-29.8 0,0 -11.4,-29.1 -27.8,-36.6 0,0 -22.9,-15.7 1.6,-15.4 0,0 24.9,2 38.6,25.8 21.9,38.6 58.6,27.5 72.9,20.9 2.3,-16 8.8,-27.1 16,-33.7 -55.9,-6.2 -112.3,-14.3 -112.3,-110.5 0,-27.5 7.6,-41.3 23.6,-58.9 -2.6,-6.5 -11.1,-33.3 2.6,-67.9 20.9,-6.5 69,27 69,27 20,-5.6 41.5,-8.5 62.8,-8.5 21.3,0 42.8,2.9 62.8,8.5 0,0 48.1,-33.6 69,-27 13.7,34.7 5.2,61.4 2.6,67.9 16,17.7 25.8,31.5 25.8,58.9 0,96.5 -58.9,104.2 -114.8,110.5 9.2,7.9 17,22.9 17,46.4 0,33.7 -0.3,75.4 -0.3,83.6 0,6.5 4.6,14.4 17.3,12.1 C 428.2,457.8 496,362.9 496,252 496,113.3 383.5,8 244.8,8 Z"/>
        </svg>
    
</a>
        

        <a id="mode_toggle" href="#" @click.prevent="handleClick" :title="mode">
    <template v-if="mode == 'light'">
        <svg width="100%" height="100%" viewBox="0 0 79 80" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g id="mode_light"><rect id="Bounds" x="0" y="-0" width="78.623" height="79.049" style="fill:none;"/><circle cx="39.311" cy="39.524" r="15.734" style="fill:#fff;"/><g id="beams"><g id="beam"><path id="beam1" serif:id="beam" d="M44.212,4.901c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,-0 -4.9,2.196 -4.9,4.901l-0,9.614c-0,2.705 2.196,4.901 4.9,4.901c2.705,0 4.901,-2.196 4.901,-4.901l0,-9.614Z" style="fill:#fff;"/></g><g id="beam2" serif:id="beam"><path id="beam3" serif:id="beam" d="M67.48,18.073c1.913,-1.912 1.913,-5.018 0,-6.931c-1.912,-1.912 -5.018,-1.912 -6.931,0l-6.798,6.799c-1.912,1.912 -1.912,5.018 0,6.931c1.913,1.912 5.018,1.912 6.931,-0l6.798,-6.799Z" style="fill:#fff;"/></g><g id="beam4" serif:id="beam"><path id="beam5" serif:id="beam" d="M25.728,61.108c1.912,-1.913 1.912,-5.018 -0,-6.931c-1.913,-1.913 -5.019,-1.913 -6.931,-0l-6.799,6.798c-1.912,1.913 -1.912,5.019 0,6.931c1.913,1.913 5.019,1.913 6.931,0l6.799,-6.798Z" style="fill:#fff;"/></g><g id="beam6" serif:id="beam"><path id="beam7" serif:id="beam" d="M60.682,54.177c-1.913,-1.913 -5.018,-1.913 -6.931,-0c-1.912,1.913 -1.912,5.018 0,6.931l6.798,6.798c1.913,1.913 5.019,1.913 6.931,0c1.913,-1.912 1.913,-5.018 0,-6.931l-6.798,-6.798Z" style="fill:#fff;"/></g><g id="beam8" serif:id="beam"><path id="beam9" serif:id="beam" d="M4.901,34.623c-2.705,0 -4.901,2.196 -4.901,4.901c0,2.705 2.196,4.901 4.901,4.901l9.614,0c2.705,0 4.901,-2.196 4.901,-4.901c0,-2.705 -2.196,-4.901 -4.901,-4.901l-9.614,0Z" style="fill:#fff;"/></g><g id="beam10" serif:id="beam"><path id="beam11" serif:id="beam" d="M44.212,64.534c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,-0 -4.9,2.196 -4.9,4.901l-0,9.614c-0,2.705 2.196,4.901 4.9,4.901c2.705,-0 4.901,-2.196 4.901,-4.901l0,-9.614Z" style="fill:#fff;"/></g><g id="beam12" serif:id="beam"><path id="beam13" serif:id="beam" d="M18.929,11.142c-1.912,-1.912 -5.018,-1.912 -6.931,0c-1.912,1.913 -1.912,5.019 0,6.931l6.799,6.799c1.912,1.912 5.018,1.912 6.931,-0c1.912,-1.913 1.912,-5.019 -0,-6.931l-6.799,-6.799Z" style="fill:#fff;"/></g><g id="beam14" serif:id="beam"><path id="beam15" serif:id="beam" d="M64.108,34.623c-2.705,0 -4.901,2.196 -4.901,4.901c-0,2.705 2.196,4.901 4.901,4.901l9.614,0c2.705,0 4.901,-2.196 4.901,-4.901c-0,-2.705 -2.196,-4.901 -4.901,-4.901l-9.614,0Z" style="fill:#fff;"/></g></g></g></svg>
    </template>

    <template v-if="mode == 'dark'">
        <svg width="100%" height="100%" viewBox="0 0 79 80" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g id="mode_dark"><rect id="Bounds" x="0" y="-0" width="78.623" height="79.049" style="fill:none;"/><circle cx="39.311" cy="39.524" r="15.734" style="fill:#fff;"/><g id="beams"><g id="beam"><path id="beam1" serif:id="beam" d="M44.212,14.515c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,0 -4.901,2.196 -4.901,4.901c0,2.705 2.197,4.901 4.901,4.901c2.705,0 4.901,-2.196 4.901,-4.901Z" style="fill:#fff;"/></g><g id="beam2" serif:id="beam"><path id="beam3" serif:id="beam" d="M60.662,24.892c1.902,-1.902 1.902,-4.99 0,-6.892l-0.04,-0.039c-1.901,-1.902 -4.989,-1.902 -6.891,-0c-1.901,1.901 -1.901,4.989 0,6.891l0.04,0.04c1.902,1.901 4.989,1.901 6.891,-0Z" style="fill:#fff;"/></g><g id="beam4" serif:id="beam"><path id="beam5" serif:id="beam" d="M25.732,61.103c1.91,-1.91 1.91,-5.011 0,-6.921l-0.009,-0.01c-1.91,-1.91 -5.012,-1.91 -6.921,-0c-1.91,1.91 -1.91,5.011 -0,6.921l0.01,0.01c1.909,1.91 5.011,1.91 6.92,-0Z" style="fill:#fff;"/></g><g id="beam6" serif:id="beam"><path id="beam7" serif:id="beam" d="M60.672,54.167c-1.907,-1.907 -5.004,-1.907 -6.911,0l-0.02,0.02c-1.907,1.907 -1.907,5.004 0,6.911c1.907,1.907 5.004,1.907 6.911,-0l0.02,-0.02c1.907,-1.907 1.907,-5.004 0,-6.911Z" style="fill:#fff;"/></g><g id="beam8" serif:id="beam"><path id="beam9" serif:id="beam" d="M14.52,34.623c-2.702,0 -4.896,2.194 -4.896,4.896l0,0.01c0,2.702 2.194,4.896 4.896,4.896c2.702,0 4.896,-2.194 4.896,-4.896l-0,-0.01c-0,-2.702 -2.194,-4.896 -4.896,-4.896Z" style="fill:#fff;"/></g><g id="beam10" serif:id="beam"><path id="beam11" serif:id="beam" d="M44.212,64.534c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,-0 -4.901,2.196 -4.901,4.901c0,2.704 2.197,4.9 4.901,4.9c2.705,0 4.901,-2.196 4.901,-4.9Z" style="fill:#fff;"/></g><g id="beam12" serif:id="beam"><path id="beam13" serif:id="beam" d="M25.73,17.943c-1.911,-1.911 -5.015,-1.911 -6.926,0l-0.005,0.005c-1.911,1.911 -1.911,5.015 0,6.926c1.911,1.911 5.015,1.911 6.926,0l0.005,-0.005c1.911,-1.911 1.911,-5.014 -0,-6.926Z" style="fill:#fff;"/></g><g id="beam14" serif:id="beam"><path id="beam15" serif:id="beam" d="M64.098,34.623c-2.699,0 -4.891,2.192 -4.891,4.892l-0,0.019c-0,2.699 2.192,4.891 4.891,4.891c2.7,0 4.892,-2.192 4.892,-4.891l0,-0.019c0,-2.7 -2.192,-4.892 -4.892,-4.892Z" style="fill:#fff;"/></g></g></g></svg>
    </template>

    <template v-if="mode == 'darkest'">
        <svg width="100%" height="100%" viewBox="0 0 79 80" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g id="mode_darkest"><rect id="Bounds" x="0" y="-0" width="78.623" height="79.049" style="fill:none;"/><path d="M39.315,23.791c8.684,-0 15.734,7.05 15.734,15.733c0,8.684 -7.05,15.734 -15.734,15.734c-8.683,0 -15.733,-7.05 -15.733,-15.734c-0,-8.683 7.05,-15.733 15.733,-15.733Zm0,4.737c6.069,0 10.997,4.927 10.997,10.996c-0,6.069 -4.928,10.996 -10.997,10.996c-6.068,0 -10.996,-4.927 -10.996,-10.996c0,-6.069 4.928,-10.996 10.996,-10.996Z" style="fill:#fff;"/><g id="beams"><g id="beam"><path id="beam1" serif:id="beam" d="M44.216,14.515c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,0 -4.9,2.196 -4.9,4.901c-0,2.705 2.196,4.901 4.9,4.901c2.705,0 4.901,-2.196 4.901,-4.901Z" style="fill:#fff;"/></g><g id="beam2" serif:id="beam"><path id="beam3" serif:id="beam" d="M60.666,24.892c1.902,-1.902 1.902,-4.99 0,-6.892l-0.04,-0.039c-1.901,-1.902 -4.989,-1.902 -6.891,-0c-1.901,1.901 -1.901,4.989 0,6.891l0.04,0.04c1.902,1.901 4.99,1.901 6.891,-0Z" style="fill:#fff;"/></g><g id="beam4" serif:id="beam"><path id="beam5" serif:id="beam" d="M25.737,61.103c1.909,-1.91 1.909,-5.011 -0,-6.921l-0.01,-0.01c-1.91,-1.91 -5.011,-1.91 -6.921,-0c-1.91,1.91 -1.91,5.011 -0,6.921l0.01,0.01c1.91,1.91 5.011,1.91 6.921,-0Z" style="fill:#fff;"/></g><g id="beam6" serif:id="beam"><path id="beam7" serif:id="beam" d="M60.676,54.167c-1.907,-1.907 -5.004,-1.907 -6.911,0l-0.02,0.02c-1.907,1.907 -1.907,5.004 0,6.911c1.907,1.907 5.004,1.907 6.911,-0l0.02,-0.02c1.907,-1.907 1.907,-5.004 0,-6.911Z" style="fill:#fff;"/></g><g id="beam8" serif:id="beam"><path id="beam9" serif:id="beam" d="M14.524,34.623c-2.702,0 -4.896,2.194 -4.896,4.896l0,0.01c0,2.702 2.194,4.896 4.896,4.896c2.702,0 4.896,-2.194 4.896,-4.896l0,-0.01c0,-2.702 -2.194,-4.896 -4.896,-4.896Z" style="fill:#fff;"/></g><g id="beam10" serif:id="beam"><path id="beam11" serif:id="beam" d="M44.216,64.534c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,-0 -4.9,2.196 -4.9,4.901c-0,2.704 2.196,4.9 4.9,4.9c2.705,0 4.901,-2.196 4.901,-4.9Z" style="fill:#fff;"/></g><g id="beam12" serif:id="beam"><path id="beam13" serif:id="beam" d="M25.734,17.943c-1.911,-1.911 -5.015,-1.911 -6.926,0l-0.005,0.005c-1.911,1.911 -1.911,5.015 0,6.926c1.911,1.911 5.015,1.911 6.926,0l0.005,-0.005c1.911,-1.911 1.911,-5.014 0,-6.926Z" style="fill:#fff;"/></g><g id="beam14" serif:id="beam"><path id="beam15" serif:id="beam" d="M64.103,34.623c-2.7,0 -4.892,2.192 -4.892,4.892l-0,0.019c-0,2.699 2.192,4.891 4.892,4.891c2.699,0 4.891,-2.192 4.891,-4.891l0,-0.019c0,-2.7 -2.192,-4.892 -4.891,-4.892Z" style="fill:#fff;"/></g></g></g></svg>
    </template>
</a>

<script>
(function() {
    const LOCAL_STORAGE_KEY = 'piccoloThemeMode'

    var initialMode = localStorage.getItem(LOCAL_STORAGE_KEY)

    if (initialMode) {
        // Make sure the value in local storage is valid
        if (['light', 'dark', 'darkest'].indexOf(initialMode) == -1) {
            initialMode = 'light'
            localStorage.setItem(LOCAL_STORAGE_KEY, initialMode)
        }
    } else {
        // Check if the client prefers dark mode
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            initialMode = 'dark'
        } else {
            initialMode = 'light'
        }
        localStorage.setItem(LOCAL_STORAGE_KEY, initialMode)
    }

    document.documentElement.dataset.mode = initialMode

    PetiteVue.createApp({
        'mode': initialMode,
        handleClick() {
            let currentMode = this.mode

            if (currentMode == 'light') {
                this.mode = 'dark'
            } else if (currentMode == 'dark') {
                this.mode = 'darkest'
            } else if (currentMode == 'darkest') {
                this.mode = 'light'
            }

            document.documentElement.dataset.mode = this.mode
            localStorage.setItem(LOCAL_STORAGE_KEY, this.mode)

            console.log(this.mode)
        }
    }).mount('#mode_toggle')
})()
</script>
            <p class="mobile_search_link">
                <a href="../search.html" title="Search">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 65 64" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2">
                        <path d="M14.873 40.009c-2.315-3.943-3.642-8.532-3.642-13.429C11.231 11.91 23.141 0 37.811 0s26.58 11.91 26.58 26.58-11.91 26.58-26.58 26.58a26.44 26.44 0 0 1-14.277-4.161L9.739 62.794a3.12 3.12 0 0 1-4.413 0L.913 58.382c-1.217-1.218-1.217-3.196 0-4.413l13.96-13.96zM37.811 8.054c10.225 0 18.526 8.301 18.526 18.526s-8.301 18.526-18.526 18.526-18.526-8.301-18.526-18.526S27.586 8.054 37.811 8.054z" fill="#fff" />
                    </svg>
                </a>
            </p>
        

        <div class="searchbox_wrapper">
            
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
    </nav>
</div>

    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper"><p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../setup/index.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tutorial_01_get_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_02_vhls.html">Vivado/Vitis HLS Backend</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Deep Dive</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="dive_01_data_types.html">Data Types and Type Casting</a></li>
<li class="toctree-l1"><a class="reference internal" href="dive_02_template.html">Template Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="dive_03_composition.html">Kernel Composition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dive/ip.html">IP Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dive/pytorch.html">PyTorch Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="dive_05_verifier.html">Equivalence Checking</a></li>
<li class="toctree-l1"><a class="reference internal" href="dive_04_features.html">Other Features</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Backends</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../backends/llvm.html">LLVM (CPU)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backends/vitis.html">AMD Vitis HLS (FPGA)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backends/tapa.html">RapidStream TAPA (FPGA)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backends/simulator.html">Multi-Threaded Simulator (CPU)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backends/aie/index.html">AMD MLIR-AIE (AI Engine)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../developer/index.html">Developer Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="developer_01_ir_builder.html">IR Builder Walkthrough</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">MLIR Translation Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">Schedule Primitives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html#data-types">Data Types</a></li>
</ul>

        </div>
      </div>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-gallery-developer-02-mlir-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="mlir-translation-guide">
<span id="sphx-glr-gallery-developer-02-mlir-py"></span><h1>MLIR Translation Guide<a class="headerlink" href="#mlir-translation-guide" title="Link to this heading"><span>¶</span></a></h1>
<p><strong>Author</strong>: Hongzheng Chen (<a class="reference external" href="mailto:hzchen&#37;&#52;&#48;cs&#46;cornell&#46;edu">hzchen<span>&#64;</span>cs<span>&#46;</span>cornell<span>&#46;</span>edu</a>)</p>
<p>This guide will give some examples on how to invoke the MLIR toolchain to
verify the correctness of a handwritten or generated MLIR program.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">allo</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</pre></div>
</div>
<section id="define-an-mlir-program-with-linalg-dialect">
<h2>Define an MLIR program with linalg dialect<a class="headerlink" href="#define-an-mlir-program-with-linalg-dialect" title="Link to this heading"><span>¶</span></a></h2>
<p>Based on the <a class="reference external" href="https://mlir.llvm.org/docs/LangRef/">MLIR</a> syntax, we can define
an MLIR program as follows. Currently our frontend is not able to generate this
linalg program, but we can still use it to invoke the MLIR toolchain.</p>
<p>Basically, linalg dialect provides lots of high-level operations, and they are
more like the NumPy operations, so we do not need to explicitly express the
for loops inside the program, which may be easier to conduct program transformations
for specific backends.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">test_mlir_program</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">func.func @matmul(%A: memref&lt;32x32xi32&gt;, %B: memref&lt;32x32xi32&gt;) -&gt; memref&lt;32x32xi32&gt; {</span>
<span class="s2">  %C = memref.alloc() : memref&lt;32x32xi32&gt;</span>
<span class="s2">  </span><span class="si">%c</span><span class="s2">0_i32 = arith.constant 0 : i32</span>
<span class="s2">  linalg.fill ins(</span><span class="si">%c</span><span class="s2">0_i32 : i32) outs(%C : memref&lt;32x32xi32&gt;)</span>
<span class="s2">  linalg.matmul ins(%A, %B: memref&lt;32x32xi32&gt;, memref&lt;32x32xi32&gt;)</span>
<span class="s2">                outs(%C: memref&lt;32x32xi32&gt;)</span>
<span class="s2">  return %C: memref&lt;32x32xi32&gt;</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For more linalg examples, please refer to the <a class="reference external" href="https://github.com/llvm/llvm-project/tree/main/mlir/test/Dialect/Linalg">linalg test suite</a>.</p>
</div>
<p>We wrap the MLIR parser in allo, so we can directly invoke it to parse the MLIR
program.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">mod</span> <span class="o">=</span> <span class="n">allo</span><span class="o">.</span><span class="n">invoke_mlir_parser</span><span class="p">(</span><span class="n">test_mlir_program</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>module {
  func.func @matmul(%arg0: memref&lt;32x32xi32&gt;, %arg1: memref&lt;32x32xi32&gt;) -&gt; memref&lt;32x32xi32&gt; {
    %alloc = memref.alloc() : memref&lt;32x32xi32&gt;
    %c0_i32 = arith.constant 0 : i32
    linalg.fill ins(%c0_i32 : i32) outs(%alloc : memref&lt;32x32xi32&gt;)
    linalg.matmul ins(%arg0, %arg1 : memref&lt;32x32xi32&gt;, memref&lt;32x32xi32&gt;) outs(%alloc : memref&lt;32x32xi32&gt;)
    return %alloc : memref&lt;32x32xi32&gt;
  }
}
</pre></div>
</div>
<p>The above result should be exactly the same as what we defined in the MLIR program,
meaning the MLIR program is valid. Otherwise, for example, if omit the return value
of <code class="docutils literal notranslate"><span class="pre">C</span></code>, you can see the following error message:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">loc</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">3</span><span class="p">):</span> <span class="n">error</span><span class="p">:</span> <span class="s1">&#39;func.return&#39;</span> <span class="n">op</span> <span class="n">has</span> <span class="mi">0</span> <span class="n">operands</span><span class="p">,</span> <span class="n">but</span> <span class="n">enclosing</span> <span class="n">function</span> <span class="p">(</span><span class="nd">@matmul</span><span class="p">)</span> <span class="n">returns</span> <span class="mi">1</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;tutorials/developer_02_mlir.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">47</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">allo</span><span class="o">.</span><span class="n">invoke_mlir_parser</span><span class="p">(</span><span class="n">test_mlir_program</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;/scratch/users/hc676/allo/allo/module.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">33</span><span class="p">,</span> <span class="ow">in</span> <span class="n">invoke_mlir_parser</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">Module</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">mod</span><span class="p">),</span> <span class="n">ctx</span><span class="p">)</span>
<span class="ne">ValueError</span><span class="p">:</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">parse</span> <span class="n">module</span> <span class="n">assembly</span> <span class="p">(</span><span class="n">see</span> <span class="n">diagnostics</span><span class="p">)</span>
</pre></div>
</div>
<p>The first line gives the error message and the exact location (line 8, column 3) of the error.
Then we know that there is a problem in the return value of our MLIR code, which helps us debug the program.</p>
<p>To further check what causes the error, we can print out the generic form of the MLIR program.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">mod</span><span class="o">.</span><span class="n">operation</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
    <span class="n">large_elements_limit</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">enable_debug_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">pretty_debug_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">print_generic_op_form</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">use_local_scope</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&quot;builtin.module&quot;() ({
  &quot;func.func&quot;() &lt;{function_type = (memref&lt;32x32xi32&gt;, memref&lt;32x32xi32&gt;) -&gt; memref&lt;32x32xi32&gt;, sym_name = &quot;matmul&quot;}&gt; ({
  ^bb0(%arg0: memref&lt;32x32xi32&gt; -:2:19, %arg1: memref&lt;32x32xi32&gt; -:2:42):
    %0 = &quot;memref.alloc&quot;() &lt;{operandSegmentSizes = array&lt;i32: 0, 0&gt;}&gt; : () -&gt; memref&lt;32x32xi32&gt; -:3:8
    %1 = &quot;arith.constant&quot;() &lt;{value = 0 : i32}&gt; : () -&gt; i32 -:4:13
    &quot;linalg.fill&quot;(%1, %0) &lt;{operandSegmentSizes = array&lt;i32: 1, 1&gt;}&gt; ({
    ^bb0(%arg5: i32 [unknown], %arg6: i32 [unknown]):
      &quot;linalg.yield&quot;(%arg5) : (i32) -&gt; () [unknown]
    }) : (i32, memref&lt;32x32xi32&gt;) -&gt; () -:5:3
    &quot;linalg.matmul&quot;(%arg0, %arg1, %0) &lt;{indexing_maps = [affine_map&lt;(d0, d1, d2) -&gt; (d0, d2)&gt;, affine_map&lt;(d0, d1, d2) -&gt; (d2, d1)&gt;, affine_map&lt;(d0, d1, d2) -&gt; (d0, d1)&gt;], operandSegmentSizes = array&lt;i32: 2, 1&gt;}&gt; ({
    ^bb0(%arg2: i32 [unknown], %arg3: i32 [unknown], %arg4: i32 [unknown]):
      %2 = &quot;arith.muli&quot;(%arg2, %arg3) &lt;{overflowFlags = #arith.overflow&lt;none&gt;}&gt; : (i32, i32) -&gt; i32 [unknown]
      %3 = &quot;arith.addi&quot;(%arg4, %2) &lt;{overflowFlags = #arith.overflow&lt;none&gt;}&gt; : (i32, i32) -&gt; i32 [unknown]
      &quot;linalg.yield&quot;(%3) : (i32) -&gt; () [unknown]
    }) : (memref&lt;32x32xi32&gt;, memref&lt;32x32xi32&gt;, memref&lt;32x32xi32&gt;) -&gt; () -:6:3
    &quot;func.return&quot;(%0) : (memref&lt;32x32xi32&gt;) -&gt; () -:8:3
  }) : () -&gt; () -:2:1
}) : () -&gt; () -:0:0
</pre></div>
</div>
<p>The generic form of the MLIR program is a more detailed representation of the MLIR program.
However, if you see this form in your customized MLIR pass, it means your generated IR may not pass the MLIR verifier.</p>
<p>We also wrap the LLVM execution engine in allo, so we can directly invoke it to execute the MLIR program.
The <code class="docutils literal notranslate"><span class="pre">LLVMMoudle</span></code> class takes the MLIR module and the name of the top function as input.
Then we can directly invoke the module with random inputs, and see if the result is correct.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To execute the MLIR with an LLVM backend, we need to lower the MLIR program to LLVM dialect first.
This is done inside the <code class="docutils literal notranslate"><span class="pre">LLVMModule</span></code> class, and you can check the details <a class="reference external" href="https://github.com/cornell-zhang/allo/blob/main/allo/module.py">here</a>.
However, we only include several lowering passes from commonly used dialects in the module,
so not all the programs can be directly lowered. You will see some examples that cannot be lowered later.</p>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">llvm_mod</span> <span class="o">=</span> <span class="n">allo</span><span class="o">.</span><span class="n">LLVMModule</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s2">&quot;matmul&quot;</span><span class="p">)</span>
<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">np_A</span></a> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/random/generated/numpy.random.randint.html#numpy.random.randint" title="numpy.random.randint" class="sphx-glr-backref-module-numpy-random sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span></a><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.int32" title="numpy.int32" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><span class="n">np</span><span class="o">.</span><span class="n">int32</span></a><span class="p">)</span>
<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">np_B</span></a> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/random/generated/numpy.random.randint.html#numpy.random.randint" title="numpy.random.randint" class="sphx-glr-backref-module-numpy-random sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span></a><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.int32" title="numpy.int32" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><span class="n">np</span><span class="o">.</span><span class="n">int32</span></a><span class="p">)</span>
<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">allo_C</span></a> <span class="o">=</span> <span class="n">llvm_mod</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">np_A</span></a><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">np_B</span></a><span class="p">)</span>
<a href="https://numpy.org/doc/stable/reference/generated/numpy.testing.assert_array_equal.html#numpy.testing.assert_array_equal" title="numpy.testing.assert_array_equal" class="sphx-glr-backref-module-numpy-testing sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_equal</span></a><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">allo_C</span></a><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">np_A</span></a> <span class="o">@</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">np_B</span></a><span class="p">)</span>
</pre></div>
</div>
<p>We verify the correctness of our handwritten MLIR program, but we definitely don’t want users to write
these tedious IR code by hand, so we need to think about how to raise the abstraction level and let
users write programs in a more friendly way. One thing we can do is to provide high-level programming
abstractions like NumPy that has lots of tensor-based operations instead of elementwise ones.
Therefore, the frontend interface may look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">kernel</span><span class="p">(</span><span class="n">A</span><span class="p">:</span> <span class="n">int32</span><span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">],</span> <span class="n">B</span><span class="p">:</span> <span class="n">int32</span><span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">int32</span><span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">]:</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">allo</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">C</span>
</pre></div>
</div>
<p>Later, we want to figure out a way to lower this high-level program to the MLIR program we defined above.</p>
</section>
<section id="define-an-mlir-program-with-tensor-dialect">
<h2>Define an MLIR program with Tensor dialect<a class="headerlink" href="#define-an-mlir-program-with-tensor-dialect" title="Link to this heading"><span>¶</span></a></h2>
<p>Not only for computation, we also need to raise the abstraction level for memory management.
Currently we explicitly use <code class="docutils literal notranslate"><span class="pre">memref</span></code> to allocate memory and pass them to the operations.
However, as users already write tensor programs, we should generate tensor interfaces instead.
Thanks to the <a class="reference external" href="https://mlir.llvm.org/docs/Dialects/TensorOps">tensor dialect</a>, we can
easily leverage it to conduct slicing, reshaping, and other tensor operations. Following
shows an example of how to use the tensor dialect to define a matmul program:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">tensor_program</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">func.func @matmul(%A: tensor&lt;32x32xi32&gt;, %B: tensor&lt;32x32xi32&gt;) -&gt; tensor&lt;32x32xi32&gt; {</span>
<span class="s2">  %C = tensor.generate {</span>
<span class="s2">      ^bb0(</span><span class="si">%i</span><span class="s2"> : index, %j : index):</span>
<span class="s2">          </span><span class="si">%c</span><span class="s2">0_i32 = arith.constant 0 : i32</span>
<span class="s2">          tensor.yield </span><span class="si">%c</span><span class="s2">0_i32 : i32</span>
<span class="s2">  } : tensor&lt;32x32xi32&gt;</span>
<span class="s2">  %1 = linalg.matmul ins(%A, %B: tensor&lt;32x32xi32&gt;, tensor&lt;32x32xi32&gt;)</span>
<span class="s2">                outs(%C: tensor&lt;32x32xi32&gt;) -&gt; tensor&lt;32x32xi32&gt;</span>
<span class="s2">  return %1 : tensor&lt;32x32xi32&gt;</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>It is very similar to the original one, but the main difference is that we use <code class="docutils literal notranslate"><span class="pre">tensor</span></code>
instead of <code class="docutils literal notranslate"><span class="pre">memref</span></code> to define the input and output of the operations.
Again, we can invoke the MLIR parser to check if the program is valid.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">mod</span> <span class="o">=</span> <span class="n">allo</span><span class="o">.</span><span class="n">invoke_mlir_parser</span><span class="p">(</span><span class="n">tensor_program</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>module {
  func.func @matmul(%arg0: tensor&lt;32x32xi32&gt;, %arg1: tensor&lt;32x32xi32&gt;) -&gt; tensor&lt;32x32xi32&gt; {
    %generated = tensor.generate  {
    ^bb0(%arg2: index, %arg3: index):
      %c0_i32 = arith.constant 0 : i32
      tensor.yield %c0_i32 : i32
    } : tensor&lt;32x32xi32&gt;
    %0 = linalg.matmul ins(%arg0, %arg1 : tensor&lt;32x32xi32&gt;, tensor&lt;32x32xi32&gt;) outs(%generated : tensor&lt;32x32xi32&gt;) -&gt; tensor&lt;32x32xi32&gt;
    return %0 : tensor&lt;32x32xi32&gt;
  }
}
</pre></div>
</div>
<p>It outputs without any error, so we know that the program is valid.
And we can also invoke the LLVM execution engine trying to execute the program.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">llvm_mod</span> <span class="o">=</span> <span class="n">allo</span><span class="o">.</span><span class="n">LLVMModule</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s2">&quot;matmul&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>You will see the following error message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>python3: llvm-project/mlir/lib/Dialect/Linalg/Transforms/Loops.cpp:209:
         mlir::FailureOr&lt;llvm::SmallVector&lt;mlir::Operation*, 4&gt; &gt; linalgOpToLoopsImpl(mlir::PatternRewriter&amp;, mlir::linalg::LinalgOp)
         [with LoopTy = mlir::AffineForOp]: Assertion `linalgOp.hasBufferSemantics() &amp;&amp; &quot;expected linalg op with buffer semantics&quot;&#39; failed.
</pre></div>
</div>
<p>Unfortunately, the program cannot be lowered to LLVM dialect, because we have not added
the lowering pass from tensor dialect to LLVM dialect, and that is something we need to do next.</p>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 0.072 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-gallery-developer-02-mlir-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/26d9fb3f431f94846c086960be43203e/developer_02_mlir.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">developer_02_mlir.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/bb81218d893c4a00ae66024e545b162d/developer_02_mlir.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">developer_02_mlir.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../_downloads/9fbd96ba55c84b58bccde28bb525c3ff/developer_02_mlir.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">zipped:</span> <span class="pre">developer_02_mlir.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
    
        <div id="show_right_sidebar">
            <p><a class="toggle_right_sidebar" href="#"><span class="icon">&lt;</span><span>Page contents</span></a></p>
        </div>

        <div id="right_sidebar">
            <p><a class="toggle_right_sidebar" href="#"><span class="icon">&gt;</span><span>Page contents:</span></a></p>
            <div class="page_toc">
                <ul>
<li><a class="reference internal" href="#">MLIR Translation Guide</a><ul>
<li><a class="reference internal" href="#define-an-mlir-program-with-linalg-dialect">Define an MLIR program with linalg dialect</a></li>
<li><a class="reference internal" href="#define-an-mlir-program-with-tensor-dialect">Define an MLIR program with Tensor dialect</a></li>
</ul>
</li>
</ul>

            </div>
        </div>
    

      <div class="clearer"></div>
    </div>
    <div class="button_nav_wrapper">
        <div class="button_nav">
            <div class="left">
                
                <a href="developer_01_ir_builder.html">
                    <span class="icon">&lt;</span><span>IR Builder Walkthrough</span></a>
                
            </div>

            <div class="right">
                
                    <a href="../api/index.html"><span>Schedule Primitives</span><span class="icon">&gt;</span></a>
                
            </div>
        </div>
    </div>


    <div class="footer" role="contentinfo">
    &#169; Copyright 2025, Allo Authors.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>

<p id="theme_credit">Styled using the <a href="https://github.com/piccolo-orm/piccolo_theme">Piccolo Theme</a></p>
  </body>
</html>